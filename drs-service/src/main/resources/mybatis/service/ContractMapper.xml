<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.stacs.nav.drs.service.dao.ContractDao">
    <!-- Result Map -->
    <resultMap id="baseResultMap" type="io.stacs.nav.drs.service.dao.po.ContractPO">
        <result column="id" property="id"/>
        <result column="block_height" property="blockHeight"/>
        <result column="tx_id" property="txId"/>
        <result column="action_index" property="actionIndex"/>
        <result column="address" property="address"/>
        <result column="name" property="name"/>
        <result column="symbol" property="symbol"/>
        <result column="extension" property="extension"/>
        <result column="bd_code" property="bdCode"/>
        <result column="status" property="status"/>
        <result column="version" property="version"/>
        <result column="code" property="code"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- contract table all fields -->
    <sql id="baseColumnList">
        id, block_height, tx_id, action_index, address,`name`,symbol,extension, bd_code, status, version, code, create_time
    </sql>

    <!-- add -->
    <insert id="add">
        INSERT INTO contract (block_height, tx_id, action_index, address,`name,`symbol,extension, bd_code, bd_code_version, status, version, code, create_time)
        VALUES (#{blockHeight}, #{txId}, #{actionIndex}, #{address},#{name},#{symbol},#{extension},#{bdCode},#{bdCodeVersion},#{status}, #{version}, #{code}, now(3))
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        insert into contract (block_height, tx_id, action_index, address,`name`,symbol,extension, bd_code,
        bd_code_version, status, version, code, create_time)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.blockHeight}, #{item.txId}, #{item.actionIndex},
            #{item.address},#{item.name},#{item.symbol},#{item.extension},
            #{item.bdCode},#{item.bdCodeVersion},#{item.status}, #{item.version}, #{item.code}, now(3))
        </foreach>
    </insert>

    <!-- delete -->
    <delete id="delete" parameterType="java.lang.String">
        DELETE FROM contract WHERE id=#{id}
    </delete>

    <!-- query by contract address -->
    <select id="queryByAddress" resultMap="baseResultMap" parameterType="java.lang.String">
        SELECT
        <include refid="baseColumnList"/>
        FROM contract WHERE address=#{address}
    </select>

    <!-- get query count -->
    <select id="getQueryCount" resultType="java.lang.Long">
        SELECT
        COUNT(1)
        FROM contract
        WHERE 1=1
        <if test="height != null">
            and block_height = #{height}
        </if>
        <if test="txId != null">
            and tx_id = #{txId}
        </if>
    </select>

    <!-- query list -->
    <select id="query" resultMap="baseResultMap">
        SELECT
        <include refid="baseColumnList"/>
        FROM contract
        WHERE 1=1
        <if test="height != null">
            and block_height = #{height}
        </if>
        <if test="txId != null and txId !=''">
            and tx_id = #{txId}
        </if>
        <if test="bdCode != null and bdCode !=''">
            and bd_code = #{bdCode}
        </if>
        <if test="bdCodeVersion != null and bdCodeVersion !=''">
            and bd_code_version = #{bdCodeVersion}
        </if>
        <if test="name != null and name !=''">
            and name = #{name}
        </if>
        <if test="symbol != null and symbol !=''">
            and symbol = #{symbol}
        </if>
        <if test="status != null and status !=''">
            and status = #{status}
        </if>
        ORDER BY id DESC
        LIMIT #{startIndex}, #{endIndex}
    </select>


    <!-- query by txId -->
    <select id="queryByTxId" resultMap="baseResultMap">
        SELECT
        <include refid="baseColumnList"/>
        FROM contract
        WHERE action_index = #{actionIndex} and tx_id = #{txId}
    </select>


</mapper>
